name: Multi-Repository Merge (feature-0.1 â†’ main)

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., 2025.01.15 or 1.0.0)'
        required: true
        type: string
        default: '2025.01.15'

      use_repo_list:
        description: 'Use repos from scripts/repos-list.txt?'
        required: true
        type: boolean
        default: true

      specific_repos:
        description: 'Override with specific repos (comma-separated)'
        required: false
        type: string

      dry_run:
        description: 'Dry run (test only, no actual merge)'
        required: true
        type: boolean
        default: true

env:
  ORG_NAME: ${{ github.repository_owner }}
  SOURCE_BRANCH: feature-0.1
  TARGET_BRANCH: main

jobs:
  prepare-repos:
    name: Prepare Repository List
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}
      total_count: ${{ steps.get-repos.outputs.total_count }}

    steps:
      - name: Checkout automation repo
        uses: actions/checkout@v4

      - name: Get repository list
        id: get-repos
        run: |
          if [ "${{ inputs.use_repo_list }}" == "true" ]; then
            REPOS=$(grep -v '^#' scripts/repos-list.txt | grep -v '^[[:space:]]*$' | jq -R -s -c 'split("\n")[:-1]')
          elif [ -n "${{ inputs.specific_repos }}" ]; then
            REPOS=$(echo '${{ inputs.specific_repos }}' | sed 's/,/\n/g' | sed 's/ //g' | jq -R -s -c 'split("\n")[:-1]')
          else
            echo "No repository list provided"
            exit 1
          fi

          COUNT=$(echo "$REPOS" | jq '. | length')

          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "total_count=$COUNT" >> $GITHUB_OUTPUT

  validate:
    name: Validate Configuration
    needs: prepare-repos
    runs-on: ubuntu-latest

    steps:
      - name: Display configuration
        run: |
          echo "Source Branch: feature-0.1"
          echo "Target Branch: main"
          echo "Release Version: ${{ inputs.release_version }}"
          echo "Total Repositories: ${{ needs.prepare-repos.outputs.total_count }}"
          echo "Dry Run Mode: ${{ inputs.dry_run }}"

          if [ "${{ needs.prepare-repos.outputs.total_count }}" -eq "0" ]; then
            echo "No repositories to process"
            exit 1
          fi

  merge-repos:
    name: Merge ${{ matrix.repo }}
    needs: [prepare-repos, validate]
    runs-on: ubuntu-latest

    strategy:
      matrix:
        repo: ${{ fromJson(needs.prepare-repos.outputs.repos) }}
      fail-fast: false
      max-parallel: 5

    steps:
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Check repository exists
        id: check-repo
        continue-on-error: true
        run: |
          if gh repo view ${{ env.ORG_NAME }}/${{ matrix.repo }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Clone repository
        if: steps.check-repo.outputs.exists == 'true'
        run: |
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ env.ORG_NAME }}/${{ matrix.repo }}.git repo

      - name: Check branches exist
        if: steps.check-repo.outputs.exists == 'true'
        id: check-branches
        continue-on-error: true
        run: |
          cd repo
          git fetch origin

          git ls-remote --heads origin feature-0.1 > /dev/null || exit 0
          git ls-remote --heads origin main > /dev/null || exit 0

          echo "source_exists=true" >> $GITHUB_OUTPUT
          echo "target_exists=true" >> $GITHUB_OUTPUT

      - name: Perform merge
        if: |
          steps.check-repo.outputs.exists == 'true' &&
          steps.check-branches.outputs.source_exists == 'true' &&
          steps.check-branches.outputs.target_exists == 'true'
        id: merge
        continue-on-error: true
        run: |
          cd repo

          git checkout main
          git pull origin main

          COMMIT_MSG="Release ${{ inputs.release_version }}: Merge feature-0.1 to main"

          if git merge origin/feature-0.1 --no-ff -m "$COMMIT_MSG"; then
            echo "status=success" >> $GITHUB_OUTPUT

            if [ "${{ inputs.dry_run }}" == "false" ]; then
              git push origin main
            else
              git log -1 --oneline
            fi
          else
            echo "status=conflict" >> $GITHUB_OUTPUT
            git merge --abort
            exit 1
          fi

      - name: Create issue on conflict
        if: failure() && steps.merge.outputs.status == 'conflict'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: '${{ matrix.repo }}',
              title: 'Merge Conflict: feature-0.1 to main',
              body: 'Manual merge required for feature-0.1 into main.'
            })

  summary:
    name: Summary Report
    needs: [prepare-repos, merge-repos]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "Merge completed from feature-0.1 to main"
          echo "Dry run: ${{ inputs.dry_run }}"
